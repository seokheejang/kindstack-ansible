---
# Next.js SSR ì•±ì„ Kind í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•˜ëŠ” í”Œë ˆì´ë¶

- name: "Next.js SSR ì•±ì„ Kind í´ëŸ¬ìŠ¤í„°ì— ë°°í¬"
  hosts: localhost
  gather_facts: false
  connection: local
  
  vars_prompt:
    - name: app_name
      prompt: "ë°°í¬í•  ì•± ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
      default: "nextjs-sample"
      private: false
    
    - name: app_image
      prompt: "ì‚¬ìš©í•  ì´ë¯¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      default: "nginx:alpine"
      private: false
    
    - name: app_replicas
      prompt: "ë³µì œë³¸ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      default: "1"
      private: false

  pre_tasks:
    - name: í•„ìˆ˜ ì¡°ê±´ í™•ì¸
      block:
        - name: kubectl ëª…ë ¹ì–´ ì¡´ì¬ í™•ì¸
          command: which kubectl
          register: kubectl_check
          failed_when: kubectl_check.rc != 0
          changed_when: false
        
        - name: Kind í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸
          command: kubectl cluster-info --context kind-kind
          register: kind_check
          failed_when: kind_check.rc != 0
          changed_when: false
        
        - name: LocalStack ìƒíƒœ í™•ì¸
          uri:
            url: "{{ localstack_endpoint }}/_localstack/health"
            method: GET
            timeout: 10
            status_code: [200, 404]  # 404ë„ í—ˆìš© (ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ë©´ ì‘ë‹µí•¨)
          register: localstack_check
          failed_when: localstack_check.status not in [200, 404]
          ignore_errors: true
        
        - name: LocalStack ëŒ€ì²´ ìƒíƒœ í™•ì¸ (í¬íŠ¸ ì²´í¬)
          wait_for:
            host: localhost
            port: 4566
            timeout: 5
          register: localstack_port_check
          when: localstack_check is failed
          failed_when: false
      
      rescue:
        - name: ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
          fail:
            msg: |
              ğŸš¨ í•„ìˆ˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:
              
              {% if kubectl_check is failed %}
              âŒ kubectl: ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ
                 í•´ê²°: brew install kubectl (macOS) ë˜ëŠ” ./scripts/setup.sh ì‹¤í–‰
              {% else %}
              âœ… kubectl: ì •ìƒ
              {% endif %}
              
              {% if kind_check is failed %}
              âŒ Kind í´ëŸ¬ìŠ¤í„°: ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
                 í•´ê²°: kind create cluster
              {% else %}
              âœ… Kind í´ëŸ¬ìŠ¤í„°: ì •ìƒ
              {% endif %}
              
              {% if localstack_check is failed and localstack_port_check is failed %}
              âŒ LocalStack: ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
                 í•´ê²°: docker-compose up -d
              {% elif localstack_check is failed %}
              âš ï¸  LocalStack: ì‹¤í–‰ ì¤‘ì´ì§€ë§Œ health ì²´í¬ ì‹¤íŒ¨ (í¬íŠ¸ëŠ” ì—´ë¦¼)
                 ë°°í¬ëŠ” ê³„ì† ì§„í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.
              {% else %}
              âœ… LocalStack: ì •ìƒ
              {% endif %}
              
              ğŸ’¡ ë¹ ë¥¸ í•´ê²°: ./scripts/setup.sh ì‹¤í–‰
      tags:
        - always

  tasks:
    - name: ë³€ìˆ˜ ì„¤ì • í™•ì¸
      debug:
        msg: |
          ë°°í¬ ì„¤ì •:
          - ì•± ì´ë¦„: {{ app_name }}
          - ì´ë¯¸ì§€: {{ app_image }}
          - ë³µì œë³¸: {{ app_replicas }}
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - Kubernetes ì»¨í…ìŠ¤íŠ¸: {{ kubernetes_context }}
          - LocalStack ì—”ë“œí¬ì¸íŠ¸: {{ localstack_endpoint }}
      tags:
        - debug

    - name: Next.js ì•± ë°°í¬
      include_role:
        name: nextjs-deploy
      tags:
        - deploy

  post_tasks:
    - name: ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
      debug:
        msg: |
          ğŸ‰ Next.js ì•± ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
          
          ğŸ“‹ í™•ì¸ ëª…ë ¹ì–´:
          kubectl get all -n {{ target_namespace }}
          
          ğŸŒ ì ‘ì† ë°©ë²•:
          ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:30080 ìœ¼ë¡œ ì ‘ì†í•˜ì„¸ìš”
          
          ğŸ“Š ë¡œê·¸ í™•ì¸:
          kubectl logs -f deployment/{{ app_name }}-deployment -n {{ target_namespace }}
          
          ğŸ§¹ ì •ë¦¬ ëª…ë ¹ì–´:
          kubectl delete namespace {{ target_namespace }}
      tags:
        - always
