---
# AWS ì¸í”„ë¼ ë¦¬ì†ŒìŠ¤ ìƒì„± ë° ê´€ë¦¬

- name: AWS ì¸í”„ë¼ ìƒì„± ì‹œì‘
  debug:
    msg: |
      AWS ì¸í”„ë¼ë¥¼ ìƒì„±í•©ë‹ˆë‹¤:
      - ë„ë©”ì¸: {{ domain_name }}
      - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
      - LocalStack ì—”ë“œí¬ì¸íŠ¸: {{ localstack_endpoint }}

- name: Route53 í˜¸ìŠ¤íŒ… ì˜ì—­ ìƒì„±
  amazon.aws.route53_zone:
    zone: "{{ domain_name }}"
    state: present
    comment: "LocalStack í…ŒìŠ¤íŠ¸ìš© í˜¸ìŠ¤íŒ… ì˜ì—­"
    aws_access_key: "{{ aws_access_key_id }}"
    aws_secret_key: "{{ aws_secret_access_key }}"
    region: "{{ aws_region }}"
    endpoint_url: "{{ localstack_endpoint }}"
  register: hosted_zone
  tags:
    - route53

- name: Route53 A ë ˆì½”ë“œ ìƒì„± (ìƒ˜í”Œ ë„ë©”ì¸)
  amazon.aws.route53:
    state: present
    zone: "{{ domain_name }}"
    record: "{{ app_name }}.{{ domain_name }}"
    type: A
    value: "127.0.0.1"  # ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©
    ttl: 300
    identifier: "{{ app_name }}-record"
    aws_access_key: "{{ aws_access_key_id }}"
    aws_secret_key: "{{ aws_secret_access_key }}"
    region: "{{ aws_region }}"
    endpoint_url: "{{ localstack_endpoint }}"
  tags:
    - route53

- name: AWS ë¦¬ì†ŒìŠ¤ ìƒì„± ì•Œë¦¼
  debug:
    msg: |
      LocalStack í™˜ê²½ì—ì„œ AWS ë¦¬ì†ŒìŠ¤ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
      ì‹¤ì œ VPC/ELB ìƒì„±ì€ LocalStack Community ë²„ì „ì—ì„œ ì œí•œì ì´ë¯€ë¡œ
      ê°œë…ì ì¸ ë¦¬ì†ŒìŠ¤ ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

- name: ê³ ìœ  ID ìƒì„±
  set_fact:
    resource_id: "{{ 99999999 | random }}"

- name: ì‹œë®¬ë ˆì´ì…˜ëœ VPC ì •ë³´ ìƒì„±
  set_fact:
    simulated_vpc:
      id: "vpc-{{ resource_id }}"
      cidr_block: "10.0.0.0/16"
      name: "{{ app_name }}-vpc"
  tags:
    - vpc

- name: ì‹œë®¬ë ˆì´ì…˜ëœ ì„œë¸Œë„· ì •ë³´ ìƒì„±
  set_fact:
    simulated_subnet:
      id: "subnet-{{ resource_id }}"
      cidr: "10.0.1.0/24"
      vpc_id: "{{ simulated_vpc.id }}"
      availability_zone: "{{ aws_region }}a"
  tags:
    - vpc

- name: ì‹œë®¬ë ˆì´ì…˜ëœ ë³´ì•ˆ ê·¸ë£¹ ì •ë³´ ìƒì„±
  set_fact:
    simulated_security_group:
      id: "sg-{{ resource_id }}"
      name: "{{ app_name }}-sg"
      vpc_id: "{{ simulated_vpc.id }}"
      rules:
        - protocol: tcp
          from_port: 80
          to_port: 80
          cidr_blocks: ["0.0.0.0/0"]
        - protocol: tcp
          from_port: 443
          to_port: 443
          cidr_blocks: ["0.0.0.0/0"]
  tags:
    - security

- name: ì‹œë®¬ë ˆì´ì…˜ëœ ë¡œë“œë°¸ëŸ°ì„œ ì •ë³´ ìƒì„±
  set_fact:
    simulated_load_balancer:
      arn: "arn:aws:elasticloadbalancing:{{ aws_region }}:123456789012:loadbalancer/app/{{ app_name }}-alb/{{ resource_id }}"
      dns_name: "{{ app_name }}-alb-{{ resource_id }}.{{ aws_region }}.elb.amazonaws.com"
      name: "{{ app_name }}-alb"
      subnets: ["{{ simulated_subnet.id }}"]
      security_groups: ["{{ simulated_security_group.id }}"]
  tags:
    - loadbalancer

- name: ì‹œë®¬ë ˆì´ì…˜ëœ íƒ€ê²Ÿ ê·¸ë£¹ ì •ë³´ ìƒì„±
  set_fact:
    simulated_target_group:
      arn: "arn:aws:elasticloadbalancing:{{ aws_region }}:123456789012:targetgroup/{{ app_name }}-tg/{{ resource_id }}"
      name: "{{ app_name }}-tg"
      port: 80
      protocol: "HTTP"
      vpc_id: "{{ simulated_vpc.id }}"
  tags:
    - loadbalancer

- name: AWS ì¸í”„ë¼ ì •ë³´ ì €ì¥
  set_fact:
    aws_infrastructure:
      hosted_zone_id: "{{ hosted_zone.zone_id }}"
      domain_name: "{{ domain_name }}"
      app_domain: "{{ app_name }}.{{ domain_name }}"
      vpc_id: "{{ simulated_vpc.id }}"
      subnet_id: "{{ simulated_subnet.id }}"
      security_group_id: "{{ simulated_security_group.id }}"
      load_balancer_arn: "{{ simulated_load_balancer.arn }}"
      load_balancer_dns: "{{ simulated_load_balancer.dns_name }}"
      target_group_arn: "{{ simulated_target_group.arn }}"
  tags:
    - always

- name: AWS ì¸í”„ë¼ ìƒì„± ê²°ê³¼ ì¶œë ¥
  debug:
    msg: |
      ğŸ‰ AWS ì¸í”„ë¼ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
      
      ğŸ“ Route53:
      - í˜¸ìŠ¤íŒ… ì˜ì—­: {{ domain_name }}
      - ì• í”Œë¦¬ì¼€ì´ì…˜ ë„ë©”ì¸: {{ app_name }}.{{ domain_name }}
      - í˜¸ìŠ¤íŒ… ì˜ì—­ ID: {{ hosted_zone.zone_id }}
      
      ğŸŒ Load Balancer (ì‹œë®¬ë ˆì´ì…˜):
      - ALB ARN: {{ simulated_load_balancer.arn }}
      - ALB DNS: {{ simulated_load_balancer.dns_name }}
      - íƒ€ê²Ÿ ê·¸ë£¹ ARN: {{ simulated_target_group.arn }}
      
      ğŸ”’ ë„¤íŠ¸ì›Œí¬ (ì‹œë®¬ë ˆì´ì…˜):
      - VPC ID: {{ simulated_vpc.id }}
      - ì„œë¸Œë„· ID: {{ simulated_subnet.id }}
      - ë³´ì•ˆ ê·¸ë£¹ ID: {{ simulated_security_group.id }}
      
      ğŸ’¡ ì°¸ê³ : LocalStack Community ë²„ì „ì˜ ì œí•œìœ¼ë¡œ ì¼ë¶€ AWS ë¦¬ì†ŒìŠ¤ëŠ” ì‹œë®¬ë ˆì´ì…˜ë©ë‹ˆë‹¤.
  tags:
    - verify
