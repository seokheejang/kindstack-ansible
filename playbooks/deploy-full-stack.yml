---
# ì „ì²´ ìŠ¤íƒ ë°°í¬: AWS + Kubernetes í†µí•© í™˜ê²½

- name: "Full Stack ë°°í¬: AWS ì¸í”„ë¼ + Kubernetes + ì• í”Œë¦¬ì¼€ì´ì…˜"
  hosts: localhost
  gather_facts: false
  connection: local
  
  vars_prompt:
    - name: app_name
      prompt: "ë°°í¬í•  ì•± ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
      default: "nextjs-sample"
      private: false
    
    - name: app_image
      prompt: "ì‚¬ìš©í•  ì´ë¯¸ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      default: "nginx:alpine"
      private: false
    
    - name: app_replicas
      prompt: "ë³µì œë³¸ ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
      default: "1"
      private: false
      
    - name: domain_name
      prompt: "ì‚¬ìš©í•  ë„ë©”ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
      default: "example.local"
      private: false

  pre_tasks:
    - name: í•„ìˆ˜ ì¡°ê±´ í™•ì¸
      block:
        - name: kubectl ëª…ë ¹ì–´ ì¡´ì¬ í™•ì¸
          command: which kubectl
          register: kubectl_check
          failed_when: kubectl_check.rc != 0
          changed_when: false
        
        - name: Kind í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸
          command: kubectl cluster-info --context kind-kind
          register: kind_check
          failed_when: kind_check.rc != 0
          changed_when: false
        
        - name: LocalStack ìƒíƒœ í™•ì¸
          uri:
            url: "{{ localstack_endpoint }}/_localstack/health"
            method: GET
            timeout: 10
            status_code: [200, 404]
          register: localstack_check
          failed_when: localstack_check.status not in [200, 404]
          ignore_errors: true
        
        - name: LocalStack ëŒ€ì²´ ìƒíƒœ í™•ì¸ (í¬íŠ¸ ì²´í¬)
          wait_for:
            host: localhost
            port: 4566
            timeout: 5
          register: localstack_port_check
          when: localstack_check is failed
          failed_when: false
      
      rescue:
        - name: ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
          fail:
            msg: |
              ğŸš¨ í•„ìˆ˜ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:
              
              {% if kubectl_check is failed %}
              âŒ kubectl: ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ
                 í•´ê²°: brew install kubectl (macOS) ë˜ëŠ” ./scripts/setup.sh ì‹¤í–‰
              {% else %}
              âœ… kubectl: ì •ìƒ
              {% endif %}
              
              {% if kind_check is failed %}
              âŒ Kind í´ëŸ¬ìŠ¤í„°: ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
                 í•´ê²°: kind create cluster
              {% else %}
              âœ… Kind í´ëŸ¬ìŠ¤í„°: ì •ìƒ
              {% endif %}
              
              {% if localstack_check is failed and localstack_port_check is failed %}
              âŒ LocalStack: ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
                 í•´ê²°: docker-compose up -d
              {% elif localstack_check is failed %}
              âš ï¸  LocalStack: ì‹¤í–‰ ì¤‘ì´ì§€ë§Œ health ì²´í¬ ì‹¤íŒ¨ (í¬íŠ¸ëŠ” ì—´ë¦¼)
                 ë°°í¬ëŠ” ê³„ì† ì§„í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤.
              {% else %}
              âœ… LocalStack: ì •ìƒ
              {% endif %}
              
              ğŸ’¡ ë¹ ë¥¸ í•´ê²°: ./scripts/setup.sh ì‹¤í–‰
      tags:
        - always

  tasks:
    - name: ë³€ìˆ˜ ì„¤ì • í™•ì¸
      debug:
        msg: |
          ğŸš€ Full Stack ë°°í¬ ì„¤ì •:
          - ì•± ì´ë¦„: {{ app_name }}
          - ì´ë¯¸ì§€: {{ app_image }}
          - ë³µì œë³¸: {{ app_replicas }}
          - ë„¤ì„ìŠ¤í˜ì´ìŠ¤: {{ target_namespace }}
          - ë„ë©”ì¸: {{ domain_name }}
          - ì• í”Œë¦¬ì¼€ì´ì…˜ FQDN: {{ app_name }}.{{ domain_name }}
          - Kubernetes ì»¨í…ìŠ¤íŠ¸: {{ kubernetes_context }}
          - LocalStack ì—”ë“œí¬ì¸íŠ¸: {{ localstack_endpoint }}
      tags:
        - debug

    - name: "1ë‹¨ê³„: AWS ì¸í”„ë¼ ìƒì„±"
      include_role:
        name: aws-infrastructure
      tags:
        - aws
        - infrastructure

    - name: "2ë‹¨ê³„: ê¸°ë³¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬"
      include_role:
        name: nextjs-deploy
      tags:
        - app
        - kubernetes

    - name: "3ë‹¨ê³„: í–¥ìƒëœ Kubernetes ë¦¬ì†ŒìŠ¤ ë°°í¬"
      include_role:
        name: k8s-enhanced
      tags:
        - enhanced
        - ingress
        - loadbalancer

  post_tasks:
    - name: ğŸ‰ Full Stack ë°°í¬ ì™„ë£Œ ë©”ì‹œì§€
      debug:
        msg: |
          ğŸ‰ Full Stack ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
          
          ğŸ—ï¸  ìƒì„±ëœ AWS ë¦¬ì†ŒìŠ¤:
          - Route53 í˜¸ìŠ¤íŒ… ì˜ì—­: {{ domain_name }}
          - ì• í”Œë¦¬ì¼€ì´ì…˜ ë„ë©”ì¸: {{ aws_infrastructure.app_domain | default(app_name + '.' + domain_name) }}
          - Application Load Balancer: {{ aws_infrastructure.load_balancer_dns | default('ì‹œë®¬ë ˆì´ì…˜ë¨') }}
          - VPC: {{ aws_infrastructure.vpc_id | default('ì‹œë®¬ë ˆì´ì…˜ë¨') }}
          
          ğŸ¯ ìƒì„±ëœ Kubernetes ë¦¬ì†ŒìŠ¤:
          - Namespace: {{ target_namespace }}
          - Deployment: {{ app_name }}-deployment
          - Services: {{ app_name }}-service (NodePort), {{ app_name }}-loadbalancer (LoadBalancer), {{ app_name }}-clusterip (ClusterIP)
          - Ingress: {{ app_name }}-ingress
          
          ğŸŒ ì ‘ì† ë°©ë²•:
          
          1ï¸âƒ£ NodePort (ê¸°ë³¸):
             http://localhost:30080
          
          2ï¸âƒ£ í¬íŠ¸ í¬ì›Œë”©:
             kubectl port-forward -n {{ target_namespace }} service/{{ app_name }}-clusterip 8080:80
             http://localhost:8080
          
          3ï¸âƒ£ Ingress (ë¡œì»¬ í…ŒìŠ¤íŠ¸):
             # /etc/hostsì— ì¶”ê°€:
             127.0.0.1 {{ app_name }}.local
             127.0.0.1 {{ aws_infrastructure.app_domain | default(app_name + '.' + domain_name) }}
             
             # NGINX Ingress í¬íŠ¸ í™•ì¸:
             kubectl get svc -n ingress-nginx ingress-nginx-controller
             
             # ì ‘ì† í…ŒìŠ¤íŠ¸:
             curl -H "Host: {{ app_name }}.local" http://localhost:80
          
          ğŸ“Š í™•ì¸ ëª…ë ¹ì–´:
          
          # AWS ë¦¬ì†ŒìŠ¤ í™•ì¸ (LocalStack)
          aws --endpoint-url={{ localstack_endpoint }} route53 list-hosted-zones
          aws --endpoint-url={{ localstack_endpoint }} elbv2 describe-load-balancers
          
          # Kubernetes ë¦¬ì†ŒìŠ¤ í™•ì¸
          kubectl get all -n {{ target_namespace }}
          kubectl get ingress -n {{ target_namespace }}
          kubectl describe ingress {{ app_name }}-ingress -n {{ target_namespace }}
          
          # ë¡œê·¸ í™•ì¸
          kubectl logs -f deployment/{{ app_name }}-deployment -n {{ target_namespace }}
          
          ğŸ§¹ ì •ë¦¬ ëª…ë ¹ì–´:
          kubectl delete namespace {{ target_namespace }}
          # LocalStack ë¦¬ì†ŒìŠ¤ëŠ” ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘ì‹œ ìë™ ì‚­ì œë¨
      tags:
        - always
