---
# í–¥ìƒëœ Kubernetes ë¦¬ì†ŒìŠ¤ ë°°í¬ (Ingress, LoadBalancer Service í¬í•¨)

- name: í–¥ìƒëœ K8s ë°°í¬ ì‹œì‘
  debug:
    msg: |
      í–¥ìƒëœ Kubernetes ë¦¬ì†ŒìŠ¤ë¥¼ ë°°í¬í•©ë‹ˆë‹¤:
      - LoadBalancer Service
      - Ingress Controller
      - ë„ë©”ì¸ ì—°ê²°: {{ aws_infrastructure.app_domain }}

- name: Ingress Controller ì„¤ì¹˜ í™•ì¸
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: ingress-nginx-controller
    namespace: ingress-nginx
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  register: ingress_controller_check
  failed_when: false
  tags:
    - ingress

- name: Ingress Controller ì„¤ì¹˜ (ì—†ëŠ” ê²½ìš°)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: ingress-nginx
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  when: ingress_controller_check.resources | length == 0
  tags:
    - ingress

- name: NGINX Ingress Controller ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì ìš©
  kubernetes.core.k8s:
    state: present
    src: "https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/kind/deploy.yaml"
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  when: ingress_controller_check.resources | length == 0
  tags:
    - ingress

- name: Ingress Controller ì¤€ë¹„ ëŒ€ê¸°
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: ingress-nginx-controller
    namespace: ingress-nginx
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
    wait: true
    wait_condition:
      type: Available
      status: "True"
    wait_timeout: 300
  when: ingress_controller_check.resources | length == 0
  tags:
    - enhanced
    - ingress

- name: Ingress Controller Webhook ì¤€ë¹„ ëŒ€ê¸°
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    namespace: ingress-nginx
    name: ingress-nginx-controller-admission
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  register: webhook_service
  until: webhook_service.resources | length > 0
  retries: 30
  delay: 10
  tags:
    - enhanced
    - ingress

- name: Webhook ì¤€ë¹„ ì™„ë£Œ ëŒ€ê¸° (ì¶”ê°€ ì•ˆì „ ëŒ€ê¸°)
  pause:
    seconds: 30
  tags:
    - enhanced
    - ingress

- name: LoadBalancer Service ìƒì„±
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "{{ app_name }}-loadbalancer"
        namespace: "{{ target_namespace }}"
        labels:
          app: "{{ app_name }}"
        annotations:
          service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
          service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
          service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
      spec:
        type: LoadBalancer
        ports:
        - port: 80
          targetPort: 80
          protocol: TCP
          name: http
        - port: 443
          targetPort: 80
          protocol: TCP
          name: https
        selector:
          app: "{{ app_name }}"
    state: present
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  register: loadbalancer_service
  tags:
    - service

- name: ClusterIP Service ìƒì„± (Ingressìš©)
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "{{ app_name }}-clusterip"
        namespace: "{{ target_namespace }}"
        labels:
          app: "{{ app_name }}"
      spec:
        type: ClusterIP
        ports:
        - port: 80
          targetPort: 80
          protocol: TCP
        selector:
          app: "{{ app_name }}"
    state: present
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  tags:
    - service

- name: Ingress ë¦¬ì†ŒìŠ¤ ìƒì„±
  kubernetes.core.k8s:
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: "{{ app_name }}-ingress"
        namespace: "{{ target_namespace }}"
        labels:
          app: "{{ app_name }}"
        annotations:
          nginx.ingress.kubernetes.io/rewrite-target: /
          nginx.ingress.kubernetes.io/ssl-redirect: "false"
          # AWS ALB ì—°ë™ ì–´ë…¸í…Œì´ì…˜ (ì„ íƒì‚¬í•­)
          alb.ingress.kubernetes.io/scheme: internet-facing
          alb.ingress.kubernetes.io/target-type: ip
          alb.ingress.kubernetes.io/load-balancer-name: "{{ app_name }}-alb"
      spec:
        ingressClassName: nginx
        rules:
        - host: "{{ aws_infrastructure.app_domain | default(app_name + '.example.local') }}"
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: "{{ app_name }}-clusterip"
                  port:
                    number: 80
        - host: localhost
          http:
            paths:
            - path: /
              pathType: Prefix
              backend:
                service:
                  name: "{{ app_name }}-clusterip"
                  port:
                    number: 80
    state: present
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  tags:
    - ingress

- name: ì„œë¹„ìŠ¤ ì—”ë“œí¬ì¸íŠ¸ ì •ë³´ ìˆ˜ì§‘
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: "{{ app_name }}-loadbalancer"
    namespace: "{{ target_namespace }}"
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  register: lb_service_info
  tags:
    - verify

- name: Ingress ì •ë³´ ìˆ˜ì§‘
  kubernetes.core.k8s_info:
    api_version: networking.k8s.io/v1
    kind: Ingress
    name: "{{ app_name }}-ingress"
    namespace: "{{ target_namespace }}"
    kubeconfig: ~/.kube/config
    context: "{{ kubernetes_context }}"
  register: ingress_info
  tags:
    - verify

- name: Kind í´ëŸ¬ìŠ¤í„° í¬íŠ¸ ë§¤í•‘ í™•ì¸
  shell: |
    docker ps --filter "name=kind-control-plane" --format "table {{ "{{" }}.Names{{ "}}" }}\t{{ "{{" }}.Ports{{ "}}" }}"
  register: kind_ports
  tags:
    - verify

- name: í–¥ìƒëœ K8s ë°°í¬ ê²°ê³¼ ì¶œë ¥
  debug:
    msg: |
      ğŸ‰ í–¥ìƒëœ Kubernetes ë¦¬ì†ŒìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!
      
      ğŸŒ ì„œë¹„ìŠ¤ ì ‘ì† ë°©ë²•:
      
      1ï¸âƒ£ NodePort (ê¸°ì¡´):
         http://localhost:30080
      
      2ï¸âƒ£ LoadBalancer Service:
         íƒ€ì…: {{ lb_service_info.resources[0].spec.type }}
         í¬íŠ¸: {{ lb_service_info.resources[0].spec.ports | map(attribute='port') | list }}
      
      3ï¸âƒ£ Ingress:
         ë„ë©”ì¸: {{ aws_infrastructure.app_domain | default(app_name + '.local') }}
         ë°±ì—”ë“œ: {{ app_name }}-clusterip:80
      
      4ï¸âƒ£ ë¡œì»¬ í…ŒìŠ¤íŠ¸:
         # /etc/hostsì— ì¶”ê°€:
         127.0.0.1 {{ app_name }}.local
         127.0.0.1 {{ aws_infrastructure.app_domain | default(app_name + '.local') }}
         
         # ê·¸ í›„ ì ‘ì†:
         curl -H "Host: {{ app_name }}.local" http://localhost:80
      
      ğŸ³ Kind í´ëŸ¬ìŠ¤í„° í¬íŠ¸:
      {{ kind_ports.stdout }}
      
      ğŸ“‹ í™•ì¸ ëª…ë ¹ì–´:
      kubectl get svc -n {{ target_namespace }}
      kubectl get ingress -n {{ target_namespace }}
      kubectl describe ingress {{ app_name }}-ingress -n {{ target_namespace }}
  tags:
    - verify
